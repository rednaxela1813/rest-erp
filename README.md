# Orders / Inventory Core (Django, TDD)

## üìå –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç ‚Äî **—è–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã –∑–∞–∫–∞–∑–æ–≤ (Orders) –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º (Inventory)**,
—Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–µ –∫–∞–∫ —á–∞—Å—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ Django-–ø—Ä–æ–¥—É–∫—Ç–∞ (SaaS / ERP / POS-—Å–∏—Å—Ç–µ–º—ã).

–¶–µ–ª—å ‚Äî –ø–æ–ª—É—á–∏—Ç—å **—Å—Ç—Ä–æ–≥–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ-–±–µ–∑–æ–ø–∞—Å–Ω—É—é –¥–æ–º–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å –∑–∞–∫–∞–∑–æ–≤**,
–∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

* –≤ POS-—Å–∏—Å—Ç–µ–º–∞—Ö,
* –≤ e-commerce,
* –≤–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö ERP-–ø—Ä–æ—Ü–µ—Å—Å–∞—Ö,
* –∫–∞–∫ –±–∞–∑—É –¥–ª—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç–∏.

–ü—Ä–æ–µ–∫—Ç —Ä–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è **—Å—Ç—Ä–æ–≥–æ —á–µ—Ä–µ–∑ TDD**, —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º:

* –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏,
* –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç–∏,
* –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏,
* –ø—Ä–æ–∑—Ä–∞—á–Ω—ã—Ö –±–∏–∑–Ω–µ—Å-–∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.

---

## üß± –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

* **Python 3.13**
* **Django**
* **Django REST Framework**
* **PostgreSQL**
* **pytest + pytest-django**
* **Docker / docker-compose**
* Row-level locking (`SELECT ... FOR UPDATE`)
* –Ø–≤–Ω—ã–µ use-case‚Äô—ã (command-style)

---

## üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

### 1. Command / Use-case driven design

–õ—é–±–æ–µ –±–∏–∑–Ω–µ—Å-–¥–µ–π—Å—Ç–≤–∏–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ –∫–∞–∫ **—è–≤–Ω—ã–π use-case**:

* `pay_order`
* `cancel_order`
* `cancel_draft_order`

‚ùå –ù–µ—Ç ‚Äú–º–∞–≥–∏–∏‚Äù –≤ `serializer.save()`
‚ùå –ù–µ—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ –≤ `views`
‚ùå –ù–µ—Ç –ø–æ–±–æ—á–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –≤ –º–æ–¥–µ–ª—è—Ö

‚úÖ –í—Å—ë –≤–∞–∂–Ω–æ–µ ‚Äî –≤ use-case‚Äô–∞—Ö

---

### 2. FSM (Finite State Machine) –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ –∑–∞–∫–∞–∑–∞

–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ‚Äî **—Å—Ç—Ä–æ–≥–∞—è –∫–æ–Ω–µ—á–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–Ω–∞—è –º–æ–¥–µ–ª—å**:

```
draft ‚Üí paid ‚Üí cancelled
draft ‚Üí cancelled
```

* –í—Å–µ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –æ–ø–∏—Å–∞–Ω—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ: `status_fsm.py`
* –û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è:

  * API
  * use-case‚Äô–æ–≤
  * –±—É–¥—É—â–µ–≥–æ UI

FSM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–∏ –≤ API-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞—Ö, –∏ –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ**.

---

### 3. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (critical)

–ü—Ä–æ–µ–∫—Ç **–±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**:

* `select_for_update()` –Ω–∞:

  * Order (–æ–ø–ª–∞—Ç–∞ / –æ—Ç–º–µ–Ω–∞)
  * Product (—Å–ø–∏—Å–∞–Ω–∏–µ / –≤–æ–∑–≤—Ä–∞—Ç —Å–∫–ª–∞–¥–∞)
* –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –≤–Ω—É—Ç—Ä–∏ `transaction.atomic()`
* –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (double-pay / double-cancel) –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

---

### 4. –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å–æ —Å–∫–ª–∞–¥–æ–º

–°–∫–ª–∞–¥ **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ –ø–æ–∑–∏—Ü–∏—è–º**:

* qty –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç—Å—è –ø–æ `product_id`
* —Å–ø–∏—Å–∞–Ω–∏–µ / –≤–æ–∑–≤—Ä–∞—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç**
* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç:

  * double-write,
  * race-conditions,
  * –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏

---

### 5. TDD –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å

–ö–∞–∂–¥–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ —Ç–µ—Å—Ç–∞–º–∏:

* happy-path
* double-actions
* rollback –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
* row-level locking
* idempotency

–¢–µ—Å—Ç—ã ‚Äî **—á–∞—Å—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞**, –∞ –Ω–µ ‚Äú–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ‚Äù.

---

## üìÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```
apps/orders/
‚îú‚îÄ‚îÄ api_views.py              # REST API (—Ç–æ–Ω–∫–∏–π —Å–ª–æ–π)
‚îú‚îÄ‚îÄ serializers.py            # API-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã + FSM
‚îú‚îÄ‚îÄ models.py                 # Order, OrderItem (–±–µ–∑ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏)
‚îú‚îÄ‚îÄ logic/
‚îÇ   ‚îú‚îÄ‚îÄ pay_order.py          # draft -> paid + stock debit
‚îÇ   ‚îú‚îÄ‚îÄ cancel_order.py       # paid -> cancelled + stock refund
‚îÇ   ‚îú‚îÄ‚îÄ cancel_draft_order.py # draft -> cancelled (–±–µ–∑ —Å–∫–ª–∞–¥–∞)
‚îÇ   ‚îî‚îÄ‚îÄ status_fsm.py         # FSM —Å—Ç–∞—Ç—É—Å–æ–≤
‚îî‚îÄ‚îÄ tests/
    ‚îú‚îÄ‚îÄ test_orders_pay.py
    ‚îú‚îÄ‚îÄ test_orders_double_pay.py
    ‚îú‚îÄ‚îÄ test_orders_cancel_refund.py
    ‚îú‚îÄ‚îÄ test_orders_double_cancel_usecase.py
    ‚îú‚îÄ‚îÄ test_orders_cancel_rollback.py
    ‚îú‚îÄ‚îÄ test_orders_stock_locking.py
    ‚îî‚îÄ‚îÄ ...
```

---

## ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ó–∞–∫–∞–∑—ã

* ‚úîÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (`draft`)
* ‚úîÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–π —Ç–æ–ª—å–∫–æ –≤ `draft`
* ‚úîÔ∏è –ü–µ—Ä–µ—Å—á—ë—Ç –∏—Ç–æ–≥–æ–≤ –∑–∞–∫–∞–∑–∞

### –û–ø–ª–∞—Ç–∞ (`pay_order`)

* ‚úîÔ∏è –¢–æ–ª—å–∫–æ `draft ‚Üí paid`
* ‚úîÔ∏è –ó–∞–ø—Ä–µ—Ç `paid ‚Üí paid`
* ‚úîÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–æ–∑–∏—Ü–∏–π
* ‚úîÔ∏è –ê–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞
* ‚úîÔ∏è Row-lock –Ω–∞ Order –∏ Product
* ‚úîÔ∏è –ü–æ–ª–Ω—ã–π rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ

### –û—Ç–º–µ–Ω–∞

* ‚úîÔ∏è `draft ‚Üí cancelled` (–±–µ–∑ —Å–∫–ª–∞–¥–∞)
* ‚úîÔ∏è `paid ‚Üí cancelled` (refund inventory)
* ‚úîÔ∏è –ó–∞–ø—Ä–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–º–µ–Ω—ã
* ‚úîÔ∏è –ó–∞–ø—Ä–µ—Ç `cancelled ‚Üí paid`
* ‚úîÔ∏è –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å–∫–ª–∞–¥–∞

### API-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

* ‚úîÔ∏è FSM-–≤–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
* ‚úîÔ∏è Use-case only commands
* ‚úîÔ∏è –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–µ 400-–æ—à–∏–±–∫–∏
* ‚úîÔ∏è –ù–µ—Ç –¥–≤–æ–π–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π

### –¢–µ—Å—Ç—ã

* ‚úîÔ∏è –í—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤
* ‚úîÔ∏è Double-pay
* ‚úîÔ∏è Double-cancel
* ‚úîÔ∏è Rollback –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º —Å–±–æ–µ
* ‚úîÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ `select_for_update`
* ‚úîÔ∏è –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å

---

## üöß –ß—Ç–æ –ø—Ä–µ–¥—Å—Ç–æ–∏—Ç —Å–¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

### –ë–ª–∏–∂–∞–π—à–∏–µ —à–∞–≥–∏ (—è–¥—Ä–æ)

1. **–Ø–≤–Ω—ã–π Status History**

   * —Ç–∞–±–ª–∏—Ü–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
   * audit-trail –¥–ª—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏

2. **Order totals freeze**

   * –∑–∞–ø—Ä–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω –ø–æ—Å–ª–µ `paid`
   * –∑–∞—â–∏—Ç–∞ –æ—Ç ‚Äú–ø–æ–¥–º–µ–Ω—ã‚Äù –¥–∞–Ω–Ω—ã—Ö

3. **Soft-delete / archive**

   * –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ cancelled –∑–∞–∫–∞–∑–æ–≤
   * —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤ API

4. **Permissions / roles**

   * –∫—Ç–æ –º–æ–∂–µ—Ç –ø–ª–∞—Ç–∏—Ç—å
   * –∫—Ç–æ –º–æ–∂–µ—Ç –æ—Ç–º–µ–Ω—è—Ç—å
   * POS vs admin

---

### –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å (ERP)

5. **Payments abstraction**

   * cash / card / online
   * –≤–Ω–µ—à–Ω–∏–π payment provider

6. **Accounting integration**

   * –ø—Ä–æ–≤–æ–¥–∫–∏ –ø—Ä–∏ `paid`
   * –ø—Ä–æ–≤–æ–¥–∫–∏ –ø—Ä–∏ `cancelled`

7. **Stock movements table**

   * –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è `stock_qty`
   * –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–∫–ª–∞–¥—Å–∫–æ–π –∂—É—Ä–Ω–∞–ª

8. **Async processing**

   * Celery / background jobs
   * –∑–∞—â–∏—Ç–∞ –æ—Ç —Ç–∞–π–º–∞—É—Ç–æ–≤ POS

---

### UI / API

9. **Allowed next statuses API**

   * `GET /orders/{id}/available-actions`

10. **OpenAPI / DRF Spectacular**

    * –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤

---

## üéØ –§–∏–ª–æ—Å–æ—Ñ–∏—è –ø—Ä–æ–µ–∫—Ç–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç **–æ—Å–æ–∑–Ω–∞–Ω–Ω–æ —Å–ª–æ–∂–Ω–µ–µ CRUD**.

–û–Ω –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã:

* –≤—ã–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –Ω–∞–≥—Ä—É–∑–∫–∏,
* –Ω–µ –ª–æ–º–∞—Ç—å—Å—è –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö,
* –±—ã—Ç—å —Ä–∞—Å—à–∏—Ä—è–µ–º—ã–º,
* –±—ã—Ç—å –ø—Ä–∏–≥–æ–¥–Ω—ã–º –¥–ª—è –¥–µ–Ω–µ–≥ –∏ —Å–∫–ª–∞–¥–∞.

–≠—Ç–æ **–Ω–µ —É—á–µ–±–Ω—ã–π –ø—Ä–∏–º–µ—Ä**, –∞ —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞.

---

## üß™ –ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å —Ç–µ—Å—Ç—ã

```bash
docker compose run --rm web pytest -q
```

---

## üë§ –°—Ç–∞—Ç—É—Å

–ü—Ä–æ–µ–∫—Ç –≤ **–∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ**, —è–¥—Ä–æ –∑–∞–∫–∞–∑–æ–≤ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ,
—Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø ‚Äî **—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–æ–º–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏**.
